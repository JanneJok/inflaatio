const CONFIG={SHEET_ID:"1tj7AbW3BkzmPZUd_pfrXmaHZrgpKgYwNljSoVoAObx8",API_KEY:"AIzaSyDbeAW-uO-vEHuPdSJPVQwR_l1Axc7Cq7g",HISTORICAL_RANGE:"Raakadata!A:F",METRICS_RANGE:"Key Metrics!A:B",CACHE_DURATION:3e5},EMAILJS_CONFIG={SERVICE_ID:"service_nnxux1e",TEMPLATE_ID:"template_evci98f",PUBLIC_KEY:"EV6UX6GIPG231yXUd"},SUPABASE_CONFIG={URL:"https://ysuhexvvgjoizrcdrxso.supabase.co",ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdWhleHZ2Z2pvaXpyY2RyeHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MDQzODksImV4cCI6MjA3ODE4MDM4OX0.0UFYz-xd_QmUEdVcKWqRo6D4QcwvAmlKDKSdu7M4ENA"},supabase=(()=>{const t={apikey:SUPABASE_CONFIG.ANON_KEY,Authorization:`Bearer ${SUPABASE_CONFIG.ANON_KEY}`,"Content-Type":"application/json"};return{from:e=>({insert:async n=>{try{const a=await fetch(`${SUPABASE_CONFIG.URL}/rest/v1/${e}`,{method:"POST",headers:t,body:JSON.stringify(n)});return{error:a.ok?null:await a.json()}}catch(t){return{error:t}}},select:async(n="*")=>{try{const a=await fetch(`${SUPABASE_CONFIG.URL}/rest/v1/${e}?select=${n}`,{method:"GET",headers:t}),o=await a.json();return{data:a.ok?o:null,error:a.ok?null:o}}catch(t){return{data:null,error:t}}}})}})(),Analytics=window.Analytics={pageLoadTime:Date.now(),async track(t,e={}){try{const n=(new Date).toISOString().split("T")[0],a=window.location.pathname,o=document.referrer?new URL(document.referrer).hostname:"direct",i=new URLSearchParams(window.location.search),r={date:n,event_type:t,page:a,referrer:o,search_query:i.get("q")||i.get("search")||i.get("query")||i.get("s")||i.get("utm_term")||null,count:1};"session_end"===t&&e.duration&&(r.session_duration=Math.round(e.duration));const{error:l}=await supabase.from("inflaatio_analytics").insert(r);l&&console.error("Analytics error:",l)}catch(t){console.debug("Analytics tracking failed:",t)}},pageView(){this.track("page_view"),this.startSessionTracking()},startSessionTracking(){this.pageLoadTime=Date.now();let t=0;const e=(e=!1)=>{const n=(Date.now()-this.pageLoadTime)/1e3;if(n>3&&n-t>=2){t=n;const a={date:(new Date).toISOString().split("T")[0],event_type:"session_end",page:window.location.pathname,referrer:document.referrer?new URL(document.referrer).hostname:"direct",search_query:null,count:1,session_duration:Math.round(n)};e?fetch(`${SUPABASE_CONFIG.URL}/rest/v1/inflaatio_analytics`,{method:"POST",headers:{apikey:SUPABASE_CONFIG.ANON_KEY,Authorization:`Bearer ${SUPABASE_CONFIG.ANON_KEY}`,"Content-Type":"application/json",Prefer:"return=minimal"},body:JSON.stringify(a),keepalive:!0}).catch(()=>{}):supabase.from("inflaatio_analytics").insert(a)}},n=setInterval(()=>{document.hidden||e(!1)},5e3);window.addEventListener("beforeunload",()=>{clearInterval(n),e(!0)}),window.addEventListener("pagehide",()=>{clearInterval(n),e(!0)}),document.addEventListener("visibilitychange",()=>{document.hidden&&e(!0)})},chartInteraction(t){this.track("chart_interaction",{chart:t})},contactForm(){this.track("contact_form")},cookieAccept(){this.track("cookie_accept")},cookieDecline(){this.track("cookie_decline")}};let inflationData=[],keyMetrics={},dataCache=new Map,lastFetch=0;async function handleContactSubmit(t){t.preventDefault();const e=t.target,n=e.querySelector(".submit-btn"),a=n.querySelector(".btn-text"),o=n.querySelector(".btn-loading"),i=document.getElementById("contactSuccess"),r=new FormData(e),l=r.get("userName").trim(),s=r.get("userEmail").trim(),c=r.get("userMessage").trim();if(l&&s&&c){n.disabled=!0,a.style.display="none",o.style.display="inline";try{const t={from_name:l,from_email:s,message:c,reply_to:s};await emailjs.send(EMAILJS_CONFIG.SERVICE_ID,EMAILJS_CONFIG.TEMPLATE_ID,t),Analytics.contactForm(),e.style.display="none",i.style.display="block";const n=document.getElementById("contact-prompt");n&&(n.style.display="none")}catch(t){console.error("Virhe viestin l√§hetyksess√§:",t),alert("Viestin l√§hetyksess√§ tapahtui virhe. Yrit√§ uudelleen."),n.disabled=!1,a.style.display="inline",o.style.display="none"}}else alert("T√§yt√§ kaikki vaaditut kent√§t.")}document.addEventListener("DOMContentLoaded",()=>{function t(){"undefined"==typeof emailjs||window.emailJsInitialized||(emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY),window.emailJsInitialized=!0)}Analytics.pageView(),t();const e=setInterval(()=>{"undefined"!=typeof emailjs&&(t(),clearInterval(e))},100);let n=null,a=null,o=null,i=null;const r=document.querySelector(".carousel-inner"),l=document.querySelector(".arrow-left"),s=document.querySelector(".arrow-right");r&&l&&s&&(l.addEventListener("click",()=>{r.scrollBy({left:-330,behavior:"smooth"})}),s.addEventListener("click",()=>{r.scrollBy({left:330,behavior:"smooth"})})),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=document.querySelector(this.getAttribute("href"));e&&e.scrollIntoView({behavior:"smooth",block:"start"})})});const c=document.getElementById("contactModal"),d=document.getElementById("contactModalBtn"),u=document.getElementById("modalClose"),h=document.getElementById("modalOverlay"),m=document.getElementById("contactForm");function y(){c&&(c.classList.remove("show"),setTimeout(()=>{c.style.display="none",document.body.style.overflow="",function(){const t=document.getElementById("contactForm"),e=document.getElementById("contactSuccess");if(t&&e){t.style.display="block",t.reset(),e.style.display="none";const n=t.querySelector(".submit-btn"),a=n?n.querySelector(".btn-text"):null,o=n?n.querySelector(".btn-loading"):null;n&&(n.disabled=!1,a&&(a.style.display="inline"),o&&(o.style.display="none"))}}()},300))}function f(t,e,n){if(!t||!e)return void console.log("Chart or data not available for update");const a=function(t,e){if(!t||!t.labels||!t.datasets)return console.log("No data available to filter"),null;const n=t.labels.length;let a;switch(e){case"6kk":a=Math.min(6,n);break;case"1v":a=Math.min(12,n);break;case"3v":a=Math.min(36,n);break;case"5v":a=Math.min(60,n);break;default:a=n}const o=Math.max(0,n-a);return{labels:t.labels.slice(o),datasets:t.datasets.map(t=>({...t,data:t.data.slice(o)}))}}(e,n);a&&(t.data=a,t.update("none"))}d&&d.addEventListener("click",function(t){t.preventDefault(),c&&(c.style.display="flex",setTimeout(()=>{c.classList.add("show")},10),document.body.style.overflow="hidden")}),u&&u.addEventListener("click",y),h&&h.addEventListener("click",y),document.addEventListener("keydown",function(t){"Escape"===t.key&&c&&c.classList.contains("show")&&y()}),m&&m.addEventListener("submit",handleContactSubmit);const g=document.querySelector("#analytiikka .chart:first-child .chart-controls");g&&g.querySelectorAll("button").forEach(t=>{t.addEventListener("click",function(){this.parentElement.querySelectorAll("button").forEach(t=>{t.classList.remove("active")}),this.classList.add("active");const t=this.textContent;console.log("üìä Inflation chart range changed to:",t),Analytics.chartInteraction("inflation_"+t),n&&o?f(n,o,t):console.log("Waiting for inflation data from Google Sheets...")})});const p=document.querySelector("#analytiikka .chart:last-child .chart-controls");async function I(t){try{const e=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(t)}?key=${CONFIG.API_KEY}`;console.log(`üìÑ Fetching directly from Google Sheets: ${t}`);const n=await fetch(e);if(!n.ok)throw new Error(`Google Sheets API error: ${n.status}`);return(await n.json()).values||[]}catch(e){throw console.error(`Error fetching range ${t}:`,e),e}}async function b(){if(window.STATIC_DATA_AVAILABLE&&"undefined"!=typeof STATIC_INFLATION_DATA)return console.log("‚úÖ Using static inline data (no API calls)"),inflationData=STATIC_INFLATION_DATA.map(t=>({date:t[0],inflation:t[1],hicp:t[2]||0})),console.log(`üìä Loaded ${inflationData.length} data points from static data (with HICP)`),C(inflationData),k(),{historical:inflationData,metrics:{}};const t="inflation_data",e=Date.now();if(dataCache.has(t)&&e-lastFetch<CONFIG.CACHE_DURATION){const e=dataCache.get(t);return inflationData=e.historical||[],keyMetrics=e.metrics||{},k(),e}try{console.log("üìÑ Fetching data through secure proxy (fallback mode)...");const[n,a]=await Promise.all([I(CONFIG.HISTORICAL_RANGE),I(CONFIG.METRICS_RANGE)]);n?.length>1&&(inflationData=function(t){const e=t[0],n=t.slice(1),a=e.indexOf("Kuukausi"),o=e.indexOf("Inflaatio %"),i=e.indexOf("Indeksi"),r=n.map(t=>{const e=t[a]||"",n=t[o]||"",r=t[i]||"",l=parseFloat(n.replace("%","").replace(",",".").trim()),s=parseFloat(r.replace(",",".").trim());return{date:e,inflation:isNaN(l)?0:l,hicp:isNaN(s)?0:s}}).filter(t=>t.date&&!isNaN(t.inflation)),l=r.sort((t,e)=>new Date(t.date+"-01")-new Date(e.date+"-01"));return C(l),l}(n)),a?.length>1&&(keyMetrics=function(t){const e={};return t.slice(1).forEach(t=>{if(t.length>=2&&t[0]&&t[1]){const n=t[0].toString().trim(),a=t[1].toString().trim();e[n]=a}}),e}(a),function(){if(!keyMetrics||0===Object.keys(keyMetrics).length)return;const t=document.querySelectorAll(".tile .highlight"),e=Object.keys(keyMetrics);t.forEach((t,n)=>{if(n<e.length){const a=keyMetrics[e[n]];if(t.textContent=a,"string"==typeof a&&a.includes("%")){const e=parseFloat(a.replace("%","").replace(",","."));isNaN(e)||(t.className=e>0?"highlight positive":e<0?"highlight negative":"highlight neutral")}}})}());const o={historical:inflationData,metrics:keyMetrics};return dataCache.set(t,o),lastFetch=e,k(),console.log("‚úÖ Data loaded successfully through proxy"),o}catch(t){return console.error("‚ùå Data fetch error:",t),function(t){const e=document.createElement("div");e.className="error-message",e.textContent=t,e.style.cssText="\n            position: fixed;\n            top: 100px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(239, 68, 68, 0.9);\n            color: white;\n            padding: 1rem 2rem;\n            border-radius: 8px;\n            z-index: 1001;\n            backdrop-filter: blur(10px);\n        ",document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},5e3)}("Tietojen lataaminen ep√§onnistui. Tarkista verkkoyhteytesi."),null}}function C(t){const e=document.getElementById("yearTableNote");if(!e||!t||0===t.length)return;const n=(new Date).getFullYear(),a=t.filter(t=>parseInt(t.date.split("-")[0])===n);if(a.length>0){const t="L√§hde: Eurostat HICP (Harmonised Index of Consumer Prices). Luvut edustavat vuosikeskiarvoja.",o=a.length;e.textContent=`${t} ${n} data perustuu ${o} kuukauteen.`}}function k(){if(!inflationData||0===inflationData.length)return void console.log("No data to update charts");console.log("üìä Updating charts with",inflationData.length,"data points");const t=inflationData.map(t=>t.date.substr(2)),e=inflationData.map(t=>t.inflation),r=inflationData.map(t=>t.hicp);if(n){o={labels:t,datasets:[{data:e,borderColor:"#4ca5ba",backgroundColor:"rgba(76, 165, 186, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#2a7ba0",pointRadius:4,pointHoverRadius:6}]};const a=document.querySelector("#analytiikka .chart:first-child .chart-controls button.active"),i=a?a.textContent:"5v";f(n,o,i)}if(a){i={labels:t,datasets:[{data:r,borderColor:"#3891a6",backgroundColor:"rgba(56, 145, 166, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#1e5a7d",pointRadius:4,pointHoverRadius:6}]};const e=document.querySelector("#analytiikka .chart:last-child .chart-controls button.active"),n=e?e.textContent:"5v";f(a,i,n)}}p&&p.querySelectorAll("button").forEach(t=>{t.addEventListener("click",function(){this.parentElement.querySelectorAll("button").forEach(t=>{t.classList.remove("active")}),this.classList.add("active");const t=this.textContent;console.log("üìà HICP chart range changed to:",t),Analytics.chartInteraction("hicp_"+t),a&&i?f(a,i,t):console.log("Waiting for HICP data from Google Sheets...")})}),document.querySelectorAll(".chart-controls").forEach(t=>{const e=Array.from(t.querySelectorAll("button")).find(t=>"5v"===t.textContent);e&&e.classList.add("active")}),window.initCharts=function(){window.chartsInitialized?console.log("‚ö†Ô∏è Charts already initialized, skipping..."):"undefined"!=typeof Chart?(console.log("üìä Initializing Chart.js charts..."),window.chartsInitialized=!0,function(){const t={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(255, 255, 255, 0.95)",titleColor:"#1a2847",bodyColor:"#6b7280",borderColor:"rgba(42, 123, 160, 0.3)",borderWidth:1,cornerRadius:8,displayColors:!1,padding:12}},scales:{x:{grid:{color:"rgba(255, 255, 255, 0.1)",drawBorder:!1},ticks:{color:"rgba(255, 255, 255, 0.7)",maxRotation:45,minRotation:45,font:{size:window.innerWidth<400?9:11},autoSkip:!0,maxTicksLimit:window.innerWidth<768?6:12}},y:{grid:{color:"rgba(255, 255, 255, 0.1)",drawBorder:!1},ticks:{color:"rgba(255, 255, 255, 0.7)",callback:function(t){return t+"%"},font:{size:window.innerWidth<400?9:11}}}},layout:{padding:{left:0,right:0,top:10,bottom:0}}},e=document.getElementById("inflationChart");if(e){const a=e.getContext("2d");n=new Chart(a,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#4ca5ba",backgroundColor:"rgba(76, 165, 186, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#2a7ba0",pointRadius:4,pointHoverRadius:6}]},options:t})}const o=document.getElementById("hicpChart");if(o){const e=o.getContext("2d");a=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#3891a6",backgroundColor:"rgba(56, 145, 166, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#1e5a7d",pointRadius:4,pointHoverRadius:6}]},options:{...t,scales:{...t.scales,y:{...t.scales.y,ticks:{...t.scales.y.ticks,callback:function(t){return t.toFixed(0)}}}}}})}console.log("‚úÖ Charts initialized. Data available:",inflationData.length>0),inflationData.length>0&&(console.log("üìä Data was loaded before charts - updating now..."),k())}()):console.error("‚ùå Chart.js not loaded yet when initCharts called")},"undefined"!=typeof Chart?(console.log("‚ö° Chart.js available on page load, initializing immediately"),window.initCharts()):console.log("‚è≥ Chart.js not loaded yet, waiting for lazy load..."),b(),window.STATIC_DATA_AVAILABLE?console.log("‚è∞ Auto-refresh disabled (using static data)"):(setInterval(b,CONFIG.CACHE_DURATION),console.log("‚è∞ Auto-refresh enabled (API mode)")),window.addEventListener("scroll",()=>{const t=document.querySelector(".navbar");window.scrollY>50?t.classList.add("scrolled"):t.classList.remove("scrolled")})});