const CONFIG={SHEET_ID:"1tj7AbW3BkzmPZUd_pfrXmaHZrgpKgYwNljSoVoAObx8",API_KEY:"AIzaSyDbeAW-uO-vEHuPdSJPVQwR_l1Axc7Cq7g",HISTORICAL_RANGE:"Raakadata!A:F",METRICS_RANGE:"Key Metrics!A:B",CACHE_DURATION:3e5},EMAILJS_CONFIG={SERVICE_ID:"service_nnxux1e",TEMPLATE_ID:"template_evci98f",PUBLIC_KEY:"EV6UX6GIPG231yXUd"};let inflationData=[],keyMetrics={},dataCache=new Map,lastFetch=0;async function handleContactSubmit(t){t.preventDefault();const e=t.target,o=e.querySelector(".submit-btn"),n=o.querySelector(".btn-text"),a=o.querySelector(".btn-loading"),r=document.getElementById("contactSuccess"),i=new FormData(e),l=i.get("userName").trim(),s=i.get("userEmail").trim(),c=i.get("userMessage").trim();if(l&&s&&c){o.disabled=!0,n.style.display="none",a.style.display="inline";try{const t={from_name:l,from_email:s,message:c,reply_to:s};await emailjs.send(EMAILJS_CONFIG.SERVICE_ID,EMAILJS_CONFIG.TEMPLATE_ID,t),e.style.display="none",r.style.display="block";const o=document.getElementById("contact-prompt");o&&(o.style.display="none")}catch(t){console.error("Virhe viestin lähetyksessä:",t),alert("Viestin lähetyksessä tapahtui virhe. Yritä uudelleen."),o.disabled=!1,n.style.display="inline",a.style.display="none"}}else alert("Täytä kaikki vaaditut kentät.")}document.addEventListener("DOMContentLoaded",()=>{emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);let t=null,e=null,o=null,n=null;const a=document.querySelector(".carousel-inner"),r=document.querySelector(".arrow-left"),i=document.querySelector(".arrow-right");a&&r&&i&&(r.addEventListener("click",()=>{a.scrollBy({left:-330,behavior:"smooth"})}),i.addEventListener("click",()=>{a.scrollBy({left:330,behavior:"smooth"})})),document.querySelectorAll('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(t){t.preventDefault();const e=document.querySelector(this.getAttribute("href"));e&&e.scrollIntoView({behavior:"smooth",block:"start"})})});const l=document.getElementById("contactModal"),s=document.getElementById("contactModalBtn"),c=document.getElementById("modalClose"),d=document.getElementById("modalOverlay"),u=document.getElementById("contactForm");function h(){l&&(l.classList.remove("show"),setTimeout(()=>{l.style.display="none",document.body.style.overflow="",function(){const t=document.getElementById("contactForm"),e=document.getElementById("contactSuccess");if(t&&e){t.style.display="block",t.reset(),e.style.display="none";const o=t.querySelector(".submit-btn"),n=o?o.querySelector(".btn-text"):null,a=o?o.querySelector(".btn-loading"):null;o&&(o.disabled=!1,n&&(n.style.display="inline"),a&&(a.style.display="none"))}}()},300))}function y(t,e,o){if(!t||!e)return void console.log("Chart or data not available for update");const n=function(t,e){if(!t||!t.labels||!t.datasets)return console.log("No data available to filter"),null;const o=t.labels.length;let n;switch(e){case"6kk":n=Math.min(6,o);break;case"1v":n=Math.min(12,o);break;case"3v":n=Math.min(36,o);break;case"5v":n=Math.min(60,o);break;default:n=o}const a=Math.max(0,o-n);return{labels:t.labels.slice(a),datasets:t.datasets.map(t=>({...t,data:t.data.slice(a)}))}}(e,o);n&&(t.data=n,t.update("none"))}s&&s.addEventListener("click",function(t){t.preventDefault(),l&&(l.style.display="flex",setTimeout(()=>{l.classList.add("show")},10),document.body.style.overflow="hidden")}),c&&c.addEventListener("click",h),d&&d.addEventListener("click",h),document.addEventListener("keydown",function(t){"Escape"===t.key&&l&&l.classList.contains("show")&&h()}),u&&u.addEventListener("submit",handleContactSubmit);const m=document.querySelector("#analytiikka .chart:first-child .chart-controls");m&&m.querySelectorAll("button").forEach(e=>{e.addEventListener("click",function(){this.parentElement.querySelectorAll("button").forEach(t=>{t.classList.remove("active")}),this.classList.add("active");const e=this.textContent;console.log("📊 Inflation chart range changed to:",e),t&&o?y(t,o,e):console.log("Waiting for inflation data from Google Sheets...")})});const f=document.querySelector("#analytiikka .chart:last-child .chart-controls");async function g(t){try{const e=`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${encodeURIComponent(t)}?key=${CONFIG.API_KEY}`;console.log(`📄 Fetching directly from Google Sheets: ${t}`);const o=await fetch(e);if(!o.ok)throw new Error(`Google Sheets API error: ${o.status}`);return(await o.json()).values||[]}catch(e){throw console.error(`Error fetching range ${t}:`,e),e}}async function p(){const t="inflation_data",e=Date.now();if(dataCache.has(t)&&e-lastFetch<CONFIG.CACHE_DURATION){const e=dataCache.get(t);return inflationData=e.historical||[],keyMetrics=e.metrics||{},b(),e}try{console.log("📄 Fetching data through secure proxy...");const[o,n]=await Promise.all([g(CONFIG.HISTORICAL_RANGE),g(CONFIG.METRICS_RANGE)]);o?.length>1&&(inflationData=function(t){const e=t[0],o=t.slice(1),n=e.indexOf("Kuukausi"),a=e.indexOf("Inflaatio %"),r=e.indexOf("Indeksi"),i=o.map(t=>{const e=t[n]||"",o=t[a]||"",i=t[r]||"",l=parseFloat(o.replace("%","").replace(",",".").trim()),s=parseFloat(i.replace(",",".").trim());return{date:e,inflation:isNaN(l)?0:l,hicp:isNaN(s)?0:s}}).filter(t=>t.date&&!isNaN(t.inflation));return i.sort((t,e)=>new Date(t.date+"-01")-new Date(e.date+"-01"))}(o)),n?.length>1&&(keyMetrics=function(t){const e={};return t.slice(1).forEach(t=>{if(t.length>=2&&t[0]&&t[1]){const o=t[0].toString().trim(),n=t[1].toString().trim();e[o]=n}}),e}(n),function(){if(!keyMetrics||0===Object.keys(keyMetrics).length)return;const t=document.querySelectorAll(".tile .highlight"),e=Object.keys(keyMetrics);t.forEach((t,o)=>{if(o<e.length){const n=keyMetrics[e[o]];if(t.textContent=n,"string"==typeof n&&n.includes("%")){const e=parseFloat(n.replace("%","").replace(",","."));isNaN(e)||(t.className=e>0?"highlight positive":e<0?"highlight negative":"highlight neutral")}}})}());const a={historical:inflationData,metrics:keyMetrics};return dataCache.set(t,a),lastFetch=e,b(),console.log("✅ Data loaded successfully through proxy"),a}catch(t){return console.error("❌ Data fetch error:",t),function(t){const e=document.createElement("div");e.className="error-message",e.textContent=t,e.style.cssText="\n            position: fixed;\n            top: 100px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(239, 68, 68, 0.9);\n            color: white;\n            padding: 1rem 2rem;\n            border-radius: 8px;\n            z-index: 1001;\n            backdrop-filter: blur(10px);\n        ",document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},5e3)}("Tietojen lataaminen epäonnistui. Tarkista verkkoyhteytesi."),null}}function b(){if(!inflationData||0===inflationData.length)return void console.log("No data to update charts");console.log("📊 Updating charts with",inflationData.length,"data points");const a=inflationData.map(t=>t.date.substr(2)),r=inflationData.map(t=>t.inflation),i=inflationData.map(t=>t.hicp);if(t){o={labels:a,datasets:[{data:r,borderColor:"#4ca5ba",backgroundColor:"rgba(76, 165, 186, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#2a7ba0",pointRadius:4,pointHoverRadius:6}]};const e=document.querySelector("#analytiikka .chart:first-child .chart-controls button.active"),n=e?e.textContent:"5v";y(t,o,n)}if(e){n={labels:a,datasets:[{data:i,borderColor:"#3891a6",backgroundColor:"rgba(56, 145, 166, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#1e5a7d",pointRadius:4,pointHoverRadius:6}]};const t=document.querySelector("#analytiikka .chart:last-child .chart-controls button.active"),o=t?t.textContent:"5v";y(e,n,o)}}f&&f.querySelectorAll("button").forEach(t=>{t.addEventListener("click",function(){this.parentElement.querySelectorAll("button").forEach(t=>{t.classList.remove("active")}),this.classList.add("active");const t=this.textContent;console.log("📈 HICP chart range changed to:",t),e&&n?y(e,n,t):console.log("Waiting for HICP data from Google Sheets...")})}),document.querySelectorAll(".chart-controls").forEach(t=>{const e=Array.from(t.querySelectorAll("button")).find(t=>"5v"===t.textContent);e&&e.classList.add("active")}),"undefined"!=typeof Chart&&function(){const o={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(255, 255, 255, 0.95)",titleColor:"#1a2847",bodyColor:"#6b7280",borderColor:"rgba(42, 123, 160, 0.3)",borderWidth:1,cornerRadius:8,displayColors:!1,padding:12}},scales:{x:{grid:{color:"rgba(255, 255, 255, 0.1)",drawBorder:!1},ticks:{color:"rgba(255, 255, 255, 0.7)",maxRotation:45,minRotation:45,font:{size:window.innerWidth<400?9:11},autoSkip:!0,maxTicksLimit:window.innerWidth<768?6:12}},y:{grid:{color:"rgba(255, 255, 255, 0.1)",drawBorder:!1},ticks:{color:"rgba(255, 255, 255, 0.7)",callback:function(t){return t+"%"},font:{size:window.innerWidth<400?9:11}}}},layout:{padding:{left:0,right:0,top:10,bottom:0}}},n=document.getElementById("inflationChart");if(n){const e=n.getContext("2d");t=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#4ca5ba",backgroundColor:"rgba(76, 165, 186, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#2a7ba0",pointRadius:4,pointHoverRadius:6}]},options:o})}const a=document.getElementById("hicpChart");if(a){const t=a.getContext("2d");e=new Chart(t,{type:"line",data:{labels:[],datasets:[{data:[],borderColor:"#3891a6",backgroundColor:"rgba(56, 145, 166, 0.1)",borderWidth:3,tension:.4,fill:!0,pointBackgroundColor:"#b8d4e3",pointBorderColor:"#1e5a7d",pointRadius:4,pointHoverRadius:6}]},options:{...o,scales:{...o.scales,y:{...o.scales.y,ticks:{...o.scales.y.ticks,callback:function(t){return t.toFixed(0)}}}}}})}}(),p(),setInterval(p,CONFIG.CACHE_DURATION),window.addEventListener("scroll",()=>{const t=document.querySelector(".navbar");window.scrollY>50?t.classList.add("scrolled"):t.classList.remove("scrolled")})});